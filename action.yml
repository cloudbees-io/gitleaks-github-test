name: gitleaks-hybrid
description: Run gitleaks compliance scan with CloudBees hybrid integration

inputs:
  cloudbees_pat_token: 
    description: Cloudbees PAT token of User
    required: true
  cloudbees_api_url: 
    description: Cloudbees API URL
    required: true
  run_id: 
    description: GHA Run ID
    required: true
  job_id:
    description: GHA Job ID
    required: true
  step_id:
    description: GHA Step ID
    required: true
  is-github-workflow:
    description: Flag to indicate if the action is running in GitHub workflow
    required: true

runs:
  using: "composite"
  steps:

    # - name: Get commit or ref info
    #   shell: bash
    #   run: |
    #     docker run --rm \
    #      -v $GITHUB_WORKSPACE:$GITHUB_WORKSPACE \
    #      -e INPUT_CLOUDBEES_API_TOKEN="${{ inputs.cloudbees_pat_token }}" \
    #      -e INPUT_CLOUDBEES_API_URL="${{ inputs.cloudbees_api_url }}" \
    #      -e INPUT_IS_GITHUB_WORKFLOW="${{ inputs.is-github-workflow }}" \
    #      -e INPUT_RUN_ID="14377182881" \
    #      -e GITHUB_REF="${{ github.ref_name }}" \
    #      -e GITHUB_WORKSPACE="$GITHUB_WORKSPACE" \
    #      -e GITHUB_ENV="$GITHUB_ENV" \
    #      public.ecr.aws/l7o7z1g8/actions/assets-plugin-chain-utils:05a491580f77c8df5fb2f8b2176c4cbcc0bd37fd \
    #      get-commit-info
         
    - name: Generate reference files 
      shell: bash
      run: |
        docker run --rm \
          -v $GITHUB_WORKSPACE:$GITHUB_WORKSPACE \
          -e INPUT_CLOUDBEES_API_TOKEN="${{ inputs.cloudbees_pat_token }}" \
          -e INPUT_CLOUDBEES_API_URL="${{ inputs.cloudbees_api_url }}" \
          -e INPUT_RUN_ID="14636561480" \
          -e INPUT_IS_GITHUB_WORKFLOW="${{ inputs.is-github-workflow }}" \
          -e GITHUB_RUN_ID="14636561480" \
          -e GITHUB_WORKFLOW_REF="AmitRamachandrann/cafe/.github/workflows/gitleaks_gha.yaml@refs/heads/demo-gha" \
          -e GITHUB_RUN_ATTEMPT="1" \
          -e GITHUB_RUN_NUMBER="6" \
          -e GITHUB_REF_NAME="demo-gha" \
          -e GITHUB_REPOSITORY="AmitRamachandrann/cafe" \
          -e GITHUB_SERVER_URL="https://github.com/AmitRamachandrann/cafe" \
          -e GITHUB_JOB="${{ github.job }}" \
          -e GITHUB_PROVIDER="GITHUB" \
          -e GITHUB_WORKSPACE="$GITHUB_WORKSPACE" \
          -e GITHUB_ENV="$GITHUB_ENV" \
          public.ecr.aws/l7o7z1g8/actions/assets-plugin-chain-utils:05a491580f77c8df5fb2f8b2176c4cbcc0bd37fd \
          generate-references --asset-type "CODE"

    # - name: List files in workspace
    #   shell: bash
    #   run: |
    #     echo "Current working directory: $(pwd)"
    #     echo "Contents of workspace:"
    #     ls -laR $GITHUB_WORKSPACE/store

    - name: Set permissions for store
      shell: bash
      run: |
        mkdir -p "$GITHUB_WORKSPACE/store"
        chmod -R 777 "$GITHUB_WORKSPACE/store"

    - name: Run gitleaks compliance plugin
      shell: bash
      run: |
        docker run --rm \
          --user $(id -u):$(id -g) \
          -v $GITHUB_WORKSPACE:$GITHUB_WORKSPACE \
          -e GITHUB_WORKSPACE="$GITHUB_WORKSPACE" \
          -e RUN_ID="${{ inputs.run_id }}" \
          -e JOB_ID="${{ inputs.job_id }}" \
          -e STEP_ID="${{ inputs.step_id }}" \
          public.ecr.aws/l7o7z1g8/actions/assets-gitleaks-scanner:3622ab1201a4a9b9692f24407a363334a6b08fa9 \
          --mode single

    - name: Complete execution plan
      shell: bash
      run: |
        docker run --rm \
          -v $GITHUB_WORKSPACE:$GITHUB_WORKSPACE \
          -e INPUT_CLOUDBEES_API_TOKEN="${{ inputs.cloudbees_pat_token }}" \
          -e INPUT_CLOUDBEES_API_URL="${{ inputs.cloudbees_api_url }}" \
          -e INPUT_RUN_ID="14636561480" \
          -e INPUT_IS_GITHUB_WORKFLOW="${{ inputs.is-github-workflow }}" \
          -e GITHUB_RUN_ID="14636561480" \
          -e GITHUB_WORKFLOW_REF="AmitRamachandrann/cafe/.github/workflows/gitleaks_gha.yaml@refs/heads/demo-gha" \
          -e GITHUB_RUN_ATTEMPT="1" \
          -e GITHUB_RUN_NUMBER="6" \
          -e GITHUB_REF_NAME="demo-gha" \
          -e GITHUB_REPOSITORY="AmitRamachandrann/cafe" \
          -e GITHUB_SERVER_URL="https://github.com/AmitRamachandrann/cafe" \
          -e GITHUB_JOB="${{ github.job }}" \
          -e GITHUB_PROVIDER="GITHUB" \
          -e GITHUB_WORKSPACE="$GITHUB_WORKSPACE" \
          -e GITHUB_ENV="$GITHUB_ENV" \
          public.ecr.aws/l7o7z1g8/actions/assets-plugin-chain-utils:05a491580f77c8df5fb2f8b2176c4cbcc0bd37fd \
          process-outputs

